---
title: Exploring the close relationship between topic modeling and non-negative matrix factorization for count data
author: Peter Carbonetto
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Relationship between NMF and topic modeling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center")
```

The **fastTopics** package implements fast optimization algorithms for
fitting topic models and non-negative matrix factorizations to count
data. This document explains the close relationship between topic
modeling and non-negative matrix factorization (NMF) for count data.

```{r load-pkgs}
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Poisson non-negative matrix factorization
-----------------------------------------

In Poisson non-negative matrix factorization
([Lee & Seung, 2001][lee-seung-2001]), the counts $x_{ij}$---elements
of an $n \times m$ counts matrix, $X$---are modeled using the Poisson
distribution:
$$
x_{ij} \sim \mathrm{Poisson}(\lambda_{ij}),
$$
where each Poisson *rate*, $\lambda_{ij}$, is given by a simple linear
combination of non-negative parameters, $f_{jk} \geq 0$ and $l_{ik}
\geq 0$, to be estimated from the data:
$$
\lambda_{ij} = \sum_{k=1}^K l_{ik} f_{jk}.
$$
The $K$ is a user-specified tuning parameter giving the "rank" of the
matrix factorization.

Function `fit_poisson_nmf` from the fastTopics package computes
*maximum-likelihood estimates* (MLEs) of the Poisson NMF
parameters. These parameters are stored as an $m \times K$ matrix $F$,
and an $n \times K$ matrix $L$. Drawing the connection to PCA, we call
$L$ the "loadings" matrix (also sometimes called the "activations"), and
$F$ is the "factors" matrix (also "basis vectors"). Here is an example
with $n = 80$, $m = 100$ and $K = 3$:

```{r fit-poisson-nmf-model, message=FALSE}
library(Matrix)
library(fastTopics)
set.seed(1)
dat  <- simulate_count_data(80,100,3)
fit1 <- fit_poisson_nmf(dat$X,k = 3,numiter = 200,verbose = FALSE)
rbind(dim(dat$X),
      dim(fit1$L),
      dim(fit1$F))
```

The NMF fitting procedure finds an $L$ and an $F$ that maximize
the likelihood,

```{r plot-loglik, fig.height=3, fig.width=3.5}
quickplot(x = 1:200,y = fit1$progress$loglik,geom = c("point","line"),
  color = I("dodgerblue"),xlab = "iteration",ylab = "loglik") +
  theme_cowplot(12)
```

or, equivalently, minimize the "deviance".

Note that the MLE is not unique; we can multiply the $k$th column of
$F$ by some positive scalar, $a_k$, and divide the corresponding
column of $L$ by the same $a_k$, the likelihood will not change.

The multinomial topic model
---------------------------

In the multinomial topic model ([Hofmann, 1999][hofmann-1999];
[Blei *et al*, 2003][blei-2003]), each sample (row of $X$) is drawn
from a multinomial distribution,
$$
x_{i1}, \ldots, x_{im} | t_i \sim \mathrm{Multinom}(t_i, \pi_i),
$$
in which $t_i = \sum_{j=1}^m x_{ij}$ is the total sample size for the
$i$th row, and the multinomial probabilities are
$$
\pi_{ij} = \sum_{k=1}^K l_{ik}^{\ast} f_{jk}^{\ast}
$$
This is similar to the definition of the Poisson rates $\lambda_{ij}$
above, except that the parameters are also constrained so that each
row of the loadings matrix $L^{\ast}$ and each column of factors
matrix $F^{\ast}$ sum to 1:
$$
\sum_{k=1}^K l_{ik} = 1, \qquad
\sum_{j=1}^m f_{jk} = 1.
$$
With the addition of these constraints, the $\pi_{ij}$'s for each row
(sample) $i$ are guaranteed to sum to 1, which is needed for the
multinomial distribution. *Give interpretation of parameters as topic
and word probabilities.*

From Poisson NMF to topic model
-------------------------------

Once we have fitted the Poisson NMF model, the multinomial topic model
is easy to recover: from maximum-likelihood estimates of the Poisson
NMF parameters, $L$ and $F$.

```{r poisson2multinom-1}
fit2 <- poisson2multinom(fit1)
```

Let's check that the new parameters satisfy the constraints that the
rows of $L$ and columns of $F$ sum to 1:

```{r poisson2multinom-2}
range(rowSums(fit2$L))
range(colSums(fit2$F))
```

The multinomial topic model is in fact a *reparameterization* of the
Poisson NMF model, and the likelihood does not change with
reparameterization. This is due to the following result:
$$
x = y
$$

From topic model to Poisson NMF
-------------------------------

*Add text here.*

Summary
-------

The Poisson NMF is easier to fit because it doesn't have the
constraints. On ther other hand, there are many reasons to prefer the
topic model for ease of analysis and interpretation; for example, the
(the $l_{ik}'s$) give the topic probabilities for each document, and
can be used to, for example, find similar documents. So we provide
functions to fit the pNMF model (`fit_poisson_nmf`) and a function to
obtain the topic model fit (`poisson2multinom`).

**TO DO NEXT**

However, the pNMF model is easier
to work with from a computational perspective because of the lack of
constraints.  

[hofmann-1999]: https://doi.org/10.1145/312624.312649

[lee-seung-2001]: http://papers.nips.cc/paper/1861-algorithms-for-non-negative-matrix-factorization

[blei-2003]: http://jmlr.csail.mit.edu/papers/v3/blei03a.html
