---
title: Exploring the close relationship between topic modeling and non-negative matrix factorization for count data
author: Peter Carbonetto
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Relationship between NMF and topic modeling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The **fastTopics** package implements fast optimization algorithms for
fitting topic models and non-negative matrix factorizations to count
data. This document explains the close relationship between topic
modeling and non-negative matrix factorization (NMF) for count data.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center")
```

## Poisson non-negative matrix factorization

In Poisson NMF ([Lee & Seung, 2001][lee-seung-2001]), the counts
$x_{ij}$---elements of an $n \times m$ counts matrix $X$---are modeled
using the Poisson distribution:
$$
x_{ij} \sim \mathrm{Poisson}(\lambda_{ij}),
$$
where each Poisson *rate*, $\lambda_{ij}$, is given by a simple linear
combination of parameters, $f_{jk}$ and $l_{ik}$, to be estimated from
the data:
$$
\lambda_{ij} = \sum_{k=1}^K l_{ik} f_{jk}.
$$

The $K$ above is a user-specified tuning parameter determining the
"rank" of the matrix factorization.

The `fit_poisson_nmf` function computes *maximum-likelihood estimates*
(MLEs) of the Poisson NMF parameters. These parameters are stored as
an $m \times K$ matrix $F$ and an $n \times K$ matrix $L$. Drawing the
connection to PCA, we call $L$ the "loadings" matrix, and $F$ the
"factors" matrix. Here's an example:

```{r fit-poisson-nmf-model, message=FALSE}
library(Matrix)
library(fastTopics)
set.seed(1)
dat <- simulate_count_data(80,100,3)
fit <- fit_poisson_nmf(dat$X,k = 3,numiter = 200,verbose = FALSE)
rbind(dim(dat$X),
      dim(fit$L),
      dim(fit$F))
```

The Poisson NMF optimization algorithm can be understood as finding 
$L$ and $F$ that maximize the likelihood,

```{r plot-loglik, fig.height=2.5, fig.width=3.5}
plot_progress_poisson_nmf(fit,x = "iter",y = "loglik")
```

or, equivalently, minimize the *deviance*.

Note that the MLE is not unique; we can multiply each column $k$ of
$F$ by some scalar $a_k$ and divide the corresponding columnof $L$ by
the same $a_k$ and the likelihood will not change.

## Topic modeling

The topic model (Hoffman, xxx) is: $$X_{i\cdot}
\sim Mult(n_i, P_i)$$ where $n_i:= \sum_j X_{ij}$ and $P = \tilde{L}
\tilde{F}^T$, where $\tilde{L}$ and $\tilde{F}$ are non-negative
matrices as above to be estimated, similar to $L$ and $F$ above, but
constrained so that each row of $\tilde{L}$ sums to 1 and each column
of $\tilde{F}$ sums to 1.  The maximum likelihood estimates for
$\tilde{L}$ and $\tilde{F}$ in the topic model are simple to obtain
from the maximum likelihood estimates for $L$ and $F$ in the pNMF
model, and vice versa. However, the pNMF model is easier to work with
from a computational perspective because of the lack of constraints.
So we provide functions to fit the pNMF model (`fit_poisson_nmf`) and
a function to obtain the topic model fit (`poisson2multinom`).

```{r test-chunk}
rnorm(10)
```

[lee-seung-2001]: http://papers.nips.cc/paper/1861-algorithms-for-non-negative-matrix-factorization
